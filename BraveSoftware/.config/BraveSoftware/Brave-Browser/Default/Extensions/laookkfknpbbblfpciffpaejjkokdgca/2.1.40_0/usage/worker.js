!function(t){var e={};function n(o){if(e[o])return e[o].exports;var r=e[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=t,n.c=e,n.d=function(t,e,o){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:o})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(o,r,function(e){return t[e]}.bind(null,r));return o},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=0)}([function(t,e,n){t.exports=n(1)},function(t,e,n){let o;o=n(2).default,self.addEventListener("connect",t=>{t.ports[0].onmessage=function(t){const e=t.data,n=e.func,r=e.params;o[n](...r)}})},function(t,e,n){"use strict";n.r(e);const o="http://momentumdash.com/local-cache-key/";var r=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){let e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))},c=async function(t){const e=await caches.open("modash-cache"),n=await e.match(o+t);let r=null;return n&&(r=await n.json()),r},a=async function(t,e){const n=await caches.open("modash-cache");await n.put(o+t,new Response(e))},i=function(t){return void 0===t?t=new Date:t instanceof Date||(t=new Date(t)),t.getHours()<4&&t.setDate(t.getDate()-1),t.getFullYear().toString()+"-"+twoDigit(t.getMonth()+1)+"-"+twoDigit(t.getDate())},u=function(){let t=null,e=null;const n={READY:"ready",UPLOADING:"uploading",UPLOADED:"uploaded"};function o(){try{const n=indexedDB.open("momo-db",1);n.onsuccess=function(){t=n.result},n.onupgradeneeded=function(o){!function(n,o){try{n.oncomplete=function(){t=o},e=o.createObjectStore("usage",{keyPath:"key"}),e.createIndex("ready",["forDate","itemUuid","status"])}catch(t){console.error(t)}}(o.target.transaction,n.result)}}catch(t){console.error(t)}}function c(){return new Promise((function(e,n){try{t?e(t):(o(),setTimeout((function(){c().then((function(t){e(t)}))}),10))}catch(t){n(t)}}))}return{status:n,increment:function(t,e,o,r){let a=null;c().then((function(c){try{const u=c.transaction(["usage"],"readwrite"),s=i(),l=u.objectStore("usage").index("ready");l.get([s,t,n.READY]).onsuccess=function(n){try{a=void 0===n.target.result?S.create(t,e):n.target.result,Array.isArray(o)||(o=[o]),o.forEach((function(t){a[t]++})),u.objectStore("usage").put(a),r&&r(n.target.result)}catch(t){console.error(t)}}}catch(t){console.error(t)}}))},saveEntity:function(t){const e={};return Object.assign(e,t),e.key=r(),e.status=n.READY,new Promise((function(t,n){c().then((function(o){try{const r=o.transaction(["usage"],"readwrite");r.oncomplete=function(e){t(e)},r.onerror=function(t){n(t)},r.objectStore("usage").put(e)}catch(t){n(t)}}))}))},prepareUnsynced:function(){return new Promise((function(t,e){c().then((function(o){try{const r=o.transaction(["usage"],"readwrite");r.oncomplete=function(){t(u)};const c=(new Date).getTime(),a=c-6e4,i=r.objectStore("usage"),u=[];let s=50;i.openCursor().onsuccess=function(t){try{let e=t.target.result;if(e&&s>0){if(e.value.status===n.READY||e.value.uploadDate<a){s--;const t=e.value;t.status=n.UPLOADING,t.uploadDate=c;e.update(t).onsuccess=function(){u.push(t)}}e.continue()}}catch(t){e()}}}catch(t){e()}})).catch((function(){e()}))}))},cleanSynced:function(t){return new Promise((function(e,n){c().then((function(o){try{const r=o.transaction(["usage"],"readwrite");r.oncomplete=function(){e()};r.objectStore("usage").openCursor().onsuccess=function(e){try{const n=e.target.result;n&&(t.map((function(t){n.value.key===t&&n.delete()})),n.continue())}catch(t){n(t)}}}catch(t){n(t)}})).catch((function(){n()}))}))}}}();let s=null,l=null,d=null,f=null;const C="Photo",O={PHOTO:1,QUOTE:2,MANTRA:3,ERROR:4,SEARCH:5,STATS:6,TIMING:7,SYSTEM:8,PHOTO_LOAD:9},p={IMPRESSION_COUNT:"impressionCount",HOVER_COUNT:"hoverCount",LOAD_COUNT:"loadCount",CLICK_COUNT:"clickCount",SECONDARY_CLICK_COUNT:"secondaryClickCount",ADMIRE_COUNT:"admireCount",STICKY_CLICK_COUNT:"stickyClickCount",STICKY_SECONDARY_CLICK_COUNT:"stickySecondaryClickCount",STICKY_HOVER_COUNT:"stickyHoverCount"},y={[O.PHOTO]:[p.IMPRESSION_COUNT,p.HOVER_COUNT,p.LOAD_COUNT,p.ADMIRE_COUNT,p.CLICK_COUNT,p.STICKY_CLICK_COUNT,p.SECONDARY_CLICK_COUNT,p.STICKY_SECONDARY_CLICK_COUNT,p.STICKY_HOVER_COUNT],[O.QUOTE]:[p.IMPRESSION_COUNT,p.HOVER_COUNT,p.LOAD_COUNT,p.CLICK_COUNT]},T={updateInterval:6e4,["loaded"+O.PHOTO]:null,["loaded"+O.QUOTE]:null,["trackedLoaded"+O.PHOTO]:null,["trackedLoaded"+O.QUOTE]:null};const h={properties:p,types:O,create:function(t,e){const n={itemUuid:t,type:e,forDate:i(),status:u.status.READY,uploadDate:0,key:r()};return y[e].forEach((function(t){n[t]=0})),n},newTabLoaded:function(){T.loadComplete=!0,Object.values(O).forEach((function(t){const e=T["loaded"+t];e&&h.recordImpression(e,t)}))},setup:function(t,e,n,o){d=t,f=e,l=o,s=n,h.sendStats()},itemLoaded:function(t,e,n){T["loaded"+e]=t,!n&&T.loadComplete&&h.recordImpression(t,e)},savePhotoError:function(t){t.itemType=C,this.saveError(t,!0,!0)},saveError:function(t){t.type=O.ERROR,navigator.connection&&(t.rtt=navigator.connection.rtt,t.down=navigator.connection.downlink),this.save(t,!0,!0)},savePhotoLoad:function(t){t.type=O.PHOTO_LOAD,navigator.connection&&(t.rtt=navigator.connection.rtt,t.down=navigator.connection.downlink),this.save(t,!0,!1)},save:function(t,e,n){t.date=(new Date).getTime(),t.type||(t.type=O.STATS),u.saveEntity(t).then((function(){e&&!n&&h.sendStats()}))},increment:function(t,e,n,o){u.increment(t,e,n,(function(){o&&h.sendStats()}))},recordStickyHover:function(t,e){this.increment(t,e,[p.HOVER_COUNT,p.STICKY_HOVER_COUNT])},recordHover:function(t,e){this.increment(t,e,p.HOVER_COUNT)},recordClick:function(t,e,n){this.increment(t,e,p.CLICK_COUNT,n)},recordStickyClick:function(t,e,n){this.increment(t,e,[p.CLICK_COUNT,p.STICKY_CLICK_COUNT],n)},recordSecondaryClick:function(t,e,n){this.increment(t,e,p.SECONDARY_CLICK_COUNT,n)},recordStickySecondaryClick:function(t,e,n){this.increment(t,e,[p.SECONDARY_CLICK_COUNT,p.STICKY_SECONDARY_CLICK_COUNT],n)},recordImpression:function(t,e){this.increment(t,e,p.IMPRESSION_COUNT)},recordAdmire:function(t){this.increment(t,O.PHOTO,p.ADMIRE_COUNT)},sendStats:function(){T.sendingScheduled=!1,s&&(T.sending?T.sendingScheduled=!0:(T.sending=!0,setTimeout(async()=>{const t=await u.prepareUnsynced();await async function(t){try{if(!t||0===t.length||!navigator.onLine)return void(T.sending=!1);let e=await c("usage-retry-after");if(e){if((new Date).getTime()<parseInt(e))return void(T.sending=!1);e=null}t.forEach(t=>{y[t.type]&&y[t.type].forEach(e=>{0===t[e]&&delete t[e]}),isNaN(t.type)&&(t.type=t.type===h.types.PHOTO?1:2),delete t.status,delete t.uploadDate});const n=await fetch(d+"collect",{method:"post",headers:m(),body:JSON.stringify(t)});if(n.ok){let t=await n.json();t&&await u.cleanSynced(t),setTimeout(()=>{T.sendingScheduled&&h.sendStats()},2e3)}else if(503===n.status){let t=n.headers.get("Retry-After");t&&(t=parseInt(t),a("usage-retry-after",(new Date).getTime()+1e3*t))}}catch(t){console.error(t)}finally{T.sending=!1}}(t)},1e3)))}};function m(){const t={"Content-Type":"application/json","X-Momentum-Version":f};return l&&(t.Authorization="Bearer "+l),s&&(t["X-Momentum-ClientId"]=s),t}setInterval(h.sendStats,T.updateInterval);var S=e.default=h}]);
//# sourceMappingURL=worker.js.map