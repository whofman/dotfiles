var fn_addin=function(l,a,e){var d=d||{};return d.styles=d.styles||{},d.commands=d.commands||{},d.dependencies=e||d.dependencies||{},d.styles.style=function(){},d.views=d.views||{},d.collect=d.collect||{},d.models=d.models||{},d.templates=d.templates||{},d.info={addin:"5965ea88-516a-41cb-a6dc-251a461d9075",widget:!0,placeholderType:"none",immediateLoad:!0,id:"introduction"},l.console.log(l.elapsed()+": "+d.info.id+" started"),d.templates=d.templates||{},d.templates["introduction-button-template"]=Handlebars.template({1:function(e,t,n,i){var o,a=this.lambda,s=this.escapeExpression;return"data-"+s(a(null!=(o=null!=e?e.data:e)?o.name:o,e))+'="'+s(a(null!=(o=null!=e?e.data:e)?o.value:o,e))+'"'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,a;return'<button class="button" '+(null!=(o=t.if.call(e,null!=e?e.data:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?o:"")+">"+this.escapeExpression("function"==typeof(a=null!=(a=t.value||(null!=e?e.value:e))?a:t.helperMissing)?a.call(e,{name:"value",hash:{},data:i}):a)+"</button>\n"},useData:!0}),d.templates["introduction-content-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,a=t.helperMissing,s="function",r=this.escapeExpression;return'<div class="prompt">\n\t<div class="question"><span class="question-title '+r(typeof(o=null!=(o=t.class||(null!=e?e.class:e))?o:a)==s?o.call(e,{name:"class",hash:{},data:i}):o)+'">'+r(typeof(o=null!=(o=t.message||(null!=e?e.message:e))?o:a)==s?o.call(e,{name:"message",hash:{},data:i}):o)+'</span></div>\n\t<div class="tip" data-test="introduction-tip"></div>\n</div>\n<div class="buttons"></div>\n'},useData:!0}),d.templates["introduction-continue-button-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<div class="continue-button-wrapper">\n    <button class="button button-continue" data-test="introdution-continue-button">Continue</button>\n</div>'},useData:!0}),d.templates["introduction-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){return'<p class="logo"><img src="img/logo-white.svg"></p>\n<p class=content></p>\n'},useData:!0}),d.templates["introduction-third-party"]=Handlebars.template({1:function(e,t,n,i){var o;return'<div class="thirdparty"><img src="'+this.escapeExpression("function"==typeof(o=null!=(o=t.logo||(null!=e?e.logo:e))?o:t.helperMissing)?o.call(e,{name:"logo",hash:{},data:i}):o)+'"></div>'},compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o,a;return'<div class="prompt">\n\t\x3c!-- '+(null!=(o=t.if.call(e,null!=e?e.logo:e,{name:"if",hash:{},fn:this.program(1,i,0),inverse:this.noop,data:i}))?o:"")+' --\x3e\n\t<div class="question"><span class="question-title">'+this.escapeExpression("function"==typeof(a=null!=(a=t.message||(null!=e?e.message:e))?a:t.helperMissing)?a.call(e,{name:"message",hash:{},data:i}):a)+'</span></div>\n\t<div class="tip" data-test="introduction-tip"></div>\n</div>\n<div class="buttons"></div>\n'},useData:!0}),d.templates["introduction-tip-template"]=Handlebars.template({compiler:[6,">= 2.0.0-beta.1"],main:function(e,t,n,i){var o;return"<div>"+this.escapeExpression("function"==typeof(o=null!=(o=t.value||(null!=e?e.value:e))?o:t.helperMissing)?o.call(e,{name:"value",hash:{},data:i}):o)+"</div>"},useData:!0}),d.styles=d.styles||{},d.styles.style=function(){var e=document.createElement("style");e.type="text/css",e.innerHTML=".intro,.intro .buttons,.intro .tip,.intro input{text-align:center}.intro .input,.intro input{color:#fff;font-weight:500;outline:0}.intro{height:100%;background:url(../img/overlay-center.png) center center no-repeat;background-size:cover;line-height:1.7em;user-select:none}.intro input{width:50%;margin:0 auto;padding-top:15px;display:block;background:0;border:0;border-bottom:3px solid #fff}.intro p{margin:0}.intro .logo{padding-top:20px}.intro img{width:80px;border-radius:100%;box-shadow:0 0 50px rgba(0,0,0,.1)}.intro .tip{margin:2rem 20px 0;font-size:1.1875rem;line-height:1.5;white-space:normal;user-select:text}.intro .tip a{text-decoration:underline}.intro .buttons{width:100%;position:absolute;bottom:0;font-size:18px}.intro .button{margin-left:18px;padding:9px 15px 10px;border-radius:100px;font-size:.9375rem}.intro .prompt{height:150px;position:absolute;top:50%;right:0;left:0;transform:translateY(-50%)}.intro .question{line-height:120%;white-space:normal}.intro .input{min-width:50%;max-width:90%;margin:0 auto;padding-top:15px;display:inline-block!important;border-bottom:3px solid #fff;line-height:normal;overflow:hidden}.intro .thirdparty img{height:200px;width:200px}.intro .loading-icon{vertical-align:baseline}.intro .loading-icon.icon-only{border-width:3px;width:var(--size);height:var(--size);--size:42px;margin-right:0}.intro .message{margin:2rem 4rem 0;display:block;font-size:2.5rem;line-height:1.3;user-select:text}.intro .continue-button-wrapper{width:50%;margin:0 auto;display:block}.continue-button-wrapper .button-continue{margin-left:0}",document.getElementsByTagName("head")[0].appendChild(e)},d.views.ExpandableInput=Backbone.View.extend({attributes:{class:"width-dynamic input",spellcheck:"false"},tagName:"input",initialize:function(){},render:function(){function t(e){var t=e.val()||e.text()||e.attr("placeholder");return t=t||""}this.fakeEl=a("<span>").hide().appendTo(document.body),this.fakeEl.text(t(this.$el)).css("font",this.$el.css("font"));var n=this;return this.$el.on("input",function(){n.fakeEl.text(t(n.$el)).css("font",n.$el.css("font"));var e=n.fakeEl.width();n.$el.css({width:e+20})}).trigger("input"),this}}),d.views.Introduction=Backbone.View.extend({attributes:{id:"introduction",class:"intro","data-test":"introduction"},template:d.templates["introduction-template"],initialize:function(){var e=this;this.activeView=null,localStorage.removeItem("doLoginOnNextLoad"),setTimeout(function(){e.render()},1)},render:function(){var e=this;l.widgetManager.hideAppsExcept(".apps .full",!0);var t=(this.options.order||"append")+"To";this.$el[t]("."+this.options.region).mHide().html(this.template()).mFadeIn(1e3);var n=localStorage.getItem("loginParams"),i=localStorage.getItem("processNewLogin");n?(d.views.loginPasswordPrompt=new d.views.LoginPasswordPrompt,this.$el.find(".content").append(d.views.loginPasswordPrompt.render(n).$el.mFadeIn(1e3)),this.processPendingLogin(n)):i?(d.views.introduction.showLoading(!0),setTimeout(function(){e.successfulLogin(null,!1,!0)},10)):l.models.customization.get("displayname")?this.promptForEmail():this.promptForName()},addGlobalListeners:function(e,t,n){"function"==typeof t&&e.listenTo(l,"globalEvent:key:enter globalEvent:key:tab",t.bind(e)),"function"==typeof n&&e.listenTo(l,"globalEvent:esc",n.bind(e))},promptForName:function(){l.sendEvent("Introduction","Name","Show"),d.views.namePrompt=new d.views.NamePrompt,this.activeView=d.views.namePrompt,this.$el.find(".content").append(d.views.namePrompt.render().$el.mFadeIn(1e3)),this.$el.find("#introduction-input").trigger("focus")},promptForEmail:function(){d.views.emailPrompt=new d.views.EmailPrompt,this.activeView=d.views.emailPrompt,this.$el.find(".content").append(d.views.emailPrompt.render().$el.mFadeIn(1e3)),this.$el.find("#introduction-input").trigger("focus")},showThirdPartyLogin:function(e){l.sendEvent("Introduction","Third Party Login","Show");var t={};t.parent=this,t.brandingInfo=e,d.views.thirdPartyLogin=new d.views.ThirdPartyLogin(t),this.activeView=d.views.thirdPartyLogin,this.$el.find(".content").append(d.views.thirdPartyLogin.render().$el.mFadeIn(1e3)),this.$el.find("#introduction-input").trigger("focus")},promptForPasswordLogin:function(e){l.sendEvent("Introduction","Password For Login","Show");var t={};t.parent=this,t.invitePending=e,d.views.loginPasswordPrompt=new d.views.LoginPasswordPrompt(t),this.activeView=d.views.loginPasswordPrompt,this.$el.find(".content").append(d.views.loginPasswordPrompt.render().$el.mFadeIn(1e3)),this.$el.find("#introduction-input").trigger("focus")},promptForPasswordCreate:function(e){l.sendEvent("Introduction","Password For Create","Show"),d.views.createPasswordPrompt=new d.views.CreatePasswordPrompt({inviteCode:e}),this.activeView=d.views.createPasswordPrompt,this.$el.find(".content").append(d.views.createPasswordPrompt.render().$el.mFadeIn(1e3)),this.$el.find("#introduction-input").trigger("focus")},promptForPasswordReset:function(){l.sendEvent("Introduction","Password For Reset","Show"),d.views.resetPasswordPrompt=new d.views.ResetPasswordPrompt,this.activeView=d.views.resetPasswordPrompt,this.$el.find(".content").append(d.views.resetPasswordPrompt.render().$el.mFadeIn(1e3)),this.$el.find("#introduction-input").trigger("focus")},doneIntroductionWithMessage:function(n){var i=this;function e(e,t){clearTimeout(i.onboardingTimeout),i.$el.mFadeOut(1e3,!1,function(){l.trigger("readyForWidgets"),l.appView.render(!0,function(){t&&a(".apps").addClass("hide-apps"),l.widgetManager.showApps(!0),l.trigger("weather:reset"),e||l.trigger("initializeOnboardingAutoSteps")}),"function"==typeof n&&n(),i.destroy()})}this.handledDone||(this.handledDone=!0,localStorage.removeItem("doLoginOnNextLoad"),l.readyForWidgets=!0,l.conditionalFeatures.featureEnabled("team")&&a("body").addClass("has-team"),l.appsReady=!1,l.onboardingEnabled?(this.onboardingTimeout=setTimeout(function(){i.stopListening(l,"onboardingStepsAnalyzed",e),l.usage&&l.usage.saveError({errorType:"introductionTimeout",errorMessage:"onboarding time limit exceeded"}),e(!0)},5e3),this.listenTo(l,"onboardingStepsAnalyzed",e)):e())},showLoading:function(e){var t=this.$el.find(".tip"),n=0,i=e?'<div class="loading"><span class="loading-icon icon-only"></span></div>':'<div class="loading"><span class="loading-icon"></span>Loading...</div>';t.html()&&(n=500),t.mFadeOut(n,!0,function(){t.html(i).mFadeIn(500)})},showMessage:function(e){var t=this.$el.find(".tip"),n=0;t.html()&&(n=500),t.mFadeOut(n,!0,function(){t.html(e).mFadeIn(500)})},destroy:function(){this.undelegateEvents(),this.$el.removeData().off(),this.remove()},processPendingLogin:function(e){var s=this,t={},n=localStorage.getItem("pendingLoginState");n&&(t.pendingState=n),e&&(t.loginParams=e),d.views.introduction.showLoading(!0),a.ajax({type:"POST",contentType:"application/json",beforeSend:l.utils.setMomentumAuthHeader,data:JSON.stringify(t),url:l.globals.urlRootLogin+"user/authenticate"}).done(function(e){s.successfulLogin(e,!0)}).fail(function(e){if(s.loading=!1,localStorage.removeItem("onetimeSent"),localStorage.removeItem("loginParams"),401===e.status){var t=localStorage.getItem("email"),n="The one-time link"+(t&&" for "+t)+" has expired."+(t&&" Try sending a new one-time login link to the same email, or use a different email address.");if(s.$el.find(".tip").html('<div class="loading">'+n+"</div>").mFadeIn(500),l.models.customization.get("displayname"))if(t){var i=new d.views.IntroductionButton({value:"Use a different email address",clicked:function(){return s.$el.find(".tip").html(""),s.$el.find(".buttons").remove(),s.promptForEmail()}});s.$el.find(".buttons").append(i.render().$el)}else{var o=new d.views.IntroductionButton({value:"Back to What's your email?",clicked:function(){return s.$el.find(".tip").html(""),s.$el.find(".buttons").remove(),s.promptForEmail()}});s.$el.find(".buttons").append(o.render().$el)}else{var a=new d.views.IntroductionButton({value:"Enter your name",clicked:function(){return s.$el.find(".tip").html(""),s.$el.find(".buttons").remove(),s.promptForName()}});s.$el.find(".buttons").append(a.render().$el)}}else s.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').mFadeIn(500)}),localStorage.removeItem("pendingLoginState")},successfulLogin:function(e,t,n){l.delayOnboardingForIntro=!0;this.loading=!1,e=e||{};var i=localStorage.getItem("user_uuid");localStorage.removeItem("unregistered"),localStorage.removeItem("registrationStatePending"),!t||i&&i===e.user_uuid||l.commandManager.execute("user.cleanup",{type:"all"}),localStorage.removeItem("loginParams"),(e.token||n)&&(l.commandManager.execute("notification.dismiss"),e.token&&localStorage.setItem("token",e.token),e.token_uuid&&localStorage.setItem("token_uuid",e.token_uuid),e.user_uuid&&localStorage.setItem("user_uuid",e.user_uuid),e.features&&l.conditionalFeatures.setFeatures(e.features),l.widgetManager.hideAppsExcept(".apps .full",!0),l.trigger("user:successfulLogin",function(){localStorage.setItem("loggedIn",l.now()),localStorage.removeItem("onetimeSent"),d.views.introduction.doneIntroductionWithMessage()}),n&&d.views.introduction.doneIntroductionWithMessage(),localStorage.removeItem("processNewLogin"))}}),d.views.NamePrompt=Backbone.View.extend({tagName:"span",template:d.templates["introduction-content-template"],events:{"keydown input":function(e){this.updateOnEnter(e),this.continueButton.showContinueButton(e)}},initialize:function(){var e=this;this.continueButton=new d.views.ContinueButton({clicked:function(){return e.save()}})},render:function(){d.views.introduction.addGlobalListeners(this,this.save);var e={message:"Hello, what's your name?"};this.$el.html(this.template(e));var t=new d.views.ExpandableInput;this.$(".question").after(t.render().$el),t.$el.attr({id:"introduction-input","data-test":"introduction-name"});var n=this;function i(){var e=n.$el.find(".question-title").outerWidth();n.$el.find(".input").css({"min-width":e}).trigger("focus")}return setTimeout(i,10),this.listenTo(l,"appsReady",i),this},updateOnEnter:function(e){l.utils.isTabOrEnter(e)&&(e.preventDefault(),e.stopPropagation(),this.save())},save:function(){l.sendEvent("Introduction","Name","Submit");var e=this,t=this.$el.find("input")[0].value.trim();t.length<1||(l.models.customization.save({displayname:t}),localStorage.setItem("tokenNeeded",!0),this.$el.mFadeOut(1e3,!0,function(){e.remove(),d.views.introduction.promptForEmail()}))}}),d.views.EmailPrompt=Backbone.View.extend({tagName:"span",template:d.templates["introduction-content-template"],events:{"keydown .input":function(e){this.updateOnEnter(e),this.continueButton.showContinueButton(e)}},initialize:function(){d.views.introduction.addGlobalListeners(this,this.checkEmail,this.handleBack);var e=this;this.continueButton=new d.views.ContinueButton({clicked:function(){return e.checkEmail()}}),this.loading=!1},render:function(){var e=this,t={message:"What's your email, "+l.models.customization.get("displayname")+"?"},n=new d.views.IntroductionButton({value:"Stay logged out",data:{name:"test",value:"introduction-offline"},clicked:function(){return l.sendEvent("Introduction","Email","Stay Logged Out Clicked"),e.stayOffline()}});this.$el.html(this.template(t)),this.$el.find(".buttons").append("Or would you rather stay logged out?").append(n.render().$el);var i=new d.views.ExpandableInput;this.$el.find(".question").after(i.render().$el),i.$el.attr({id:"introduction-input","data-test":"introduction-email"});var o=this;function a(){var e=o.$el.find(".question-title").outerWidth();o.$el.find(".input").css({"min-width":e}).trigger("focus")}return setTimeout(a,10),this.listenTo(l,"appsReady",a),this},handleBack:function(){l.sendEvent("Introduction","Email","Escape Pressed"),this.stayOffline()},updateOnEnter:function(e){l.utils.isTabOrEnter(e)&&(e.preventDefault(),this.checkEmail())},stayOffline:function(){if(localStorage.stayOffline=!0,localStorage.removeItem("onetimeSent"),localStorage.removeItem("pendingLoginState"),localStorage.removeItem("loginParams"),localStorage.getItem("unregistered")&&localStorage.getItem("token"))return l.delayOnboardingForIntro=!0,l.widgetManager.hideAppsExcept(".apps .full",!0),d.views.introduction.doneIntroductionWithMessage(),void this.remove();var i=this;d.views.introduction.showLoading(),i.loading=!0,a.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({name:l.models.customization.get("displayname"),version:l.globals.version}),beforeSend:l.utils.setMomentumAuthHeader,url:l.globals.urlRootLogin+"user/register?canceled=true"}).done(function(e){l.delayOnboardingForIntro=!0,i.loading=!1,e.token&&(localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid),localStorage.setItem("unregistered",!0),localStorage.removeItem("registrationStatePending"),l.widgetManager.hideAppsExcept(".apps .full",!0),d.views.introduction.doneIntroductionWithMessage(function(){i.remove()})),e.settings&&l.syncCoordinator.loadSettings(e.settings)}).fail(function(e){var t="An error occurred. Please try again shortly.";e.responseJSON&&e.responseJSON.msg&&(t=e.responseJSON.msg);var n=new d.views.IntroductionTip({value:t});i.$el.find(".tip").html(n.render().$el.mFadeIn(500)),i.loading=!1})},checkEmail:function(){l.sendEvent("Introduction","Email","Submit");var t=this,n=this.$el.find(".input").val().trim();if(n&&!(n.length<1))if(l.utils.validateEmail(n))t.loading||(t.loading=!0,localStorage.setItem("email",n),d.views.introduction.showLoading(),a.ajax({type:"GET",contentType:"application/json",beforeSend:l.utils.setMomentumAuthHeader,url:l.globals.urlRootApi+"user-search?email="+encodeURIComponent(n)}).done(function(e){e&&e.managedDomain?t.$el.mFadeOut(1e3,!0,function(){t.remove(),e.brandingInfo=e.brandingInfo||{},d.views.introduction.showThirdPartyLogin(e.brandingInfo),l.commandManager.execute("auth.thirdparty",n,function(){console.log("callback")})}):t.$el.mFadeOut(1e3,!0,function(){t.remove(),d.views.introduction.promptForPasswordLogin(e.invitePending)})}).fail(function(e){404===e.status?t.$el.mFadeOut(1e3,!0,function(){t.remove(),d.views.introduction.promptForPasswordCreate()}):(t.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').mFadeIn(500),t.loading=!1)}));else{var e=new d.views.IntroductionTip({value:"Sorry, "+n+" doesn't seem to be a valid email address. Please try again."});this.$el.find(".tip").html(e.render().$el.mFadeIn(500))}}}),d.views.ThirdPartyLogin=Backbone.View.extend({template:d.templates["introduction-third-party"],brandingInfoBase:{messageTemplate:"Logging in to {{companyName}}...",subMessageTemplate:"Redirecting to {{idProviderName}} to verify your account."},render:function(){var e=this,t=Object.assign({},this.brandingInfoBase,this.options.brandingInfo),n={message:t.message||t.messageTemplate.replace("{{companyName}}",t.companyName).replace("{{idProviderName}}",t.idProviderName),logo:t.logo};this.$el.html(this.template(n));var i=t.subMessage||t.subMessageTemplate.replace("{{companyName}}",t.companyName).replace("{{idProviderName}}",t.idProviderName);e.$el.find(".tip").text(i).addClass("loading").mFadeIn(500);var o=new d.views.IntroductionButton({value:"Back to What's your email?",clicked:function(){return e.returnToLogin()}});return this.$el.find(".buttons").append(o.render().$el),this},returnToLogin:function(){l.sendEvent("Introduction","Third Party Login","Return to Login Clicked");var e=this;localStorage.removeItem("onetimeSent"),e.$el.mFadeOut(1e3,!0,function(){e.remove(),l.models.customization.get("displayname")?d.views.introduction.promptForEmail():d.views.introduction.promptForName()})}}),d.views.LoginPasswordPrompt=Backbone.View.extend({tagName:"span",template:d.templates["introduction-content-template"],events:{"keydown input":function(e){this.updateOnEnter(e),this.continueButton.showContinueButton(e)}},initialize:function(e){d.views.introduction.addGlobalListeners(this,this.login,this.handleBack),this.loading=!1;var t=this;this.continueButton=new d.views.ContinueButton({clicked:function(){return t.act()}}),e&&(this.invitePending=e.invitePending,this.parent=e.parent)},render:function(e){var t=this,n={message:this.invitePending?"Please check your email for an invitation to your Momentum team account.":"What's your password?",class:this.invitePending?"message":""};if(this.$el.html(this.template(e?null:n)),e)return this;var i=new d.views.IntroductionButton({value:"Use a different email address",clicked:function(){return t.changeEmail()}}),o=new d.views.IntroductionButton({value:"Change your password",data:{name:"test",value:"reset-password-button"},clicked:function(){return t.resetPassword()}});if(this.$el.find(".buttons").append(i.render().$el),this.$el.find(".buttons").append(o.render().$el),this.invitePending)return this;var a=new d.views.ExpandableInput;this.$el.find(".question").after(a.render().$el),a.$el.attr({id:"introduction-input","data-test":"introduction-prompt-password"}),this.$el.find(".input").attr("type","password").trigger("focus");var s=this;function r(){var e=s.$el.find(".question-title").outerWidth();s.$el.find(".input").css({"min-width":e}).trigger("focus")}return setTimeout(r,10),this.listenTo(l,"appsReady",r),this},handleBack:function(){l.sendEvent("Introduction","Password For Login","Escape Pressed"),this.changeEmail()},updateOnEnter:function(e){l.utils.isTabOrEnter(e)&&this.act()},changeEmail:function(){l.sendEvent("Introduction","Password For Login","Change Email Clicked");var e=this;e.$el.mFadeOut(1e3,!0,function(){e.remove(),l.models.customization.get("displayname")?d.views.introduction.promptForEmail():d.views.introduction.promptForName()})},resetPassword:function(){l.sendEvent("Introduction","Password For Login","Reset Password Clicked");var e=this;e.$el.mFadeOut(1e3,!0,function(){e.remove(),d.views.introduction.promptForPasswordReset()})},act:function(){this.invitePending?this.verifyInviteCode():this.login()},login:function(){l.sendEvent("Introduction","Password For Login","Submit");var t=this,e=localStorage.email,n=this.$el.find("input")[0].value;n.length<6?d.views.introduction.showMessage("Passwords need to be at least 6 characters long."):t.loading||(t.loading=!0,d.views.introduction.showLoading(),a.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({username:e,password:n}),beforeSend:l.utils.setMomentumAuthHeader,url:l.globals.urlRootLogin+"user/authenticate"}).done(function(e){t.successfulLogin(e)}).fail(function(e){400===e.status||401===e.status?d.views.introduction.showMessage("The password you entered for the email "+localStorage.email+" isn't right."):429===e.status?d.views.introduction.showMessage('<div class="loading">Your account has been locked due to too many incorrect password attempts. Please try again in 5 minutes.</div>'):d.views.introduction.showMessage('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>'),t.loading=!1}))},successfulLogin:function(e,t){l.delayOnboardingForIntro=!0;var n=this;localStorage.removeItem("unregistered"),localStorage.removeItem("registrationStatePending"),t&&l.commandManager.execute("user.cleanup",{type:"all"}),e.token&&(l.commandManager.execute("notification.dismiss"),localStorage.token=e.token,l.usage.setup(l.globals.urlRootStats,l.globals.version,localStorage.getItem("client_uuid"),e.token),e.token_uuid&&(localStorage.token_uuid=e.token_uuid),e.features&&l.conditionalFeatures.setFeatures(e.features),l.widgetManager.hideAppsExcept(".apps .full",!0),l.trigger("user:successfulLogin",function(){localStorage.setItem("loggedIn",l.now()),localStorage.removeItem("onetimeSent"),d.views.introduction.doneIntroductionWithMessage(function(){n.remove()})}))},verifyInviteCode:function(){l.sendEvent("Introduction","Invited team member first login","Submit");var n=this,e=localStorage.email,t=this.$el.find("input")[0].value;if(6===t.length)n.loading||(n.loading=!0,d.views.introduction.showLoading(),a.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({username:e,code:t}),beforeSend:l.utils.setMomentumAuthHeader,url:l.globals.urlRootLogin+"user/verify-invite"}).done(function(){n.loading=!1,n.$el.mFadeOut(1e3,!0,function(){n.remove(),n.parent.promptForPasswordCreate(t)})}).fail(function(e){if(400===e.status||401===e.status){var t=new d.views.IntroductionTip({value:"The invite code you entered for the email "+localStorage.email+" isn't right."});n.$el.find(".tip").html(t.render().$el.mFadeIn(500)),n.loading=!1}else n.loading=!1,n.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').mFadeIn(500)}));else{var i=new d.views.IntroductionTip({value:"Invitation codes are 6 digits long."});n.$el.find(".tip").html(i.render().$el.mFadeIn(500))}}}),d.views.CreatePasswordPrompt=Backbone.View.extend({tagName:"span",template:d.templates["introduction-content-template"],events:{"keydown input":function(e){this.updateOnEnter(e),this.continueButton.showContinueButton(e)}},initialize:function(e){d.views.introduction.addGlobalListeners(this,this.create,this.handleBack),this.loading=!1;var t=this;this.continueButton=new d.views.ContinueButton({clicked:function(){return t.create()}}),e&&(this.inviteCode=e.inviteCode)},render:function(){var e=this,t={message:"Please choose a password."},n=new d.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}});this.$el.html(this.template(t));var i=new d.views.ExpandableInput;this.$el.find(".question").after(i.render().$el),i.$el.attr({id:"introduction-input","data-test":"introduction-create-password"}),this.$el.find("input").attr("type","password").trigger("focus"),this.$el.find(".buttons").append(n.render().$el),this.$(".tip").html('Momentum respects your privacy. Learn more in our <a href="https://momentumdash.com/legal" target="_blank">Terms & Privacy Policy</a>.');var o=this;function a(){var e=o.$el.find(".question-title").outerWidth();o.$el.find(".input").css({"min-width":e}).trigger("focus")}return setTimeout(a,10),this.listenTo(l,"appsReady",a),this},updateOnEnter:function(e){l.utils.isTabOrEnter(e)&&this.create()},handleBack:function(){l.sendEvent("Introduction","Password For Create","Escape Pressed"),this.changeEmail()},changeEmail:function(){l.sendEvent("Introduction","Password For Create","Change Email Clicked");var e=this;e.$el.mFadeOut(1e3,!0,function(){e.remove(),d.views.introduction.promptForEmail()})},create:function(){l.sendEvent("Introduction","Password For Create","Submit");var i=this,e=localStorage.email,t=this.$el.find("input")[0].value;if(t.length<6){var n=new d.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});i.$el.find(".tip").html(n.render().$el.mFadeIn(500))}else if(!i.loading){i.loading=!0,d.views.introduction.showLoading();var o=this.inviteCode?l.globals.urlRootLogin+"user/create-password":l.globals.urlRootLogin+"user/register";a.ajax({type:"POST",contentType:"application/json",beforeSend:l.utils.setMomentumAuthHeader,data:JSON.stringify({name:l.models.customization.get("displayname"),email:e,password:t,invite:this.inviteCode,version:l.globals.version}),url:o}).done(function(e){l.delayOnboardingForIntro=!0,e.token?(localStorage.token=e.token,e.token_uuid&&(localStorage.token_uuid=e.token_uuid),localStorage.removeItem("registrationStatePending")):e.first_time_key&&(localStorage.first_time_key=e.first_time_key,localStorage.next_login_attempt=l.now(),e.token_uuid&&(localStorage.token_uuid=e.token_uuid)),e.settings&&l.syncCoordinator.loadSettings(e.settings),localStorage.removeItem("unregistered"),l.widgetManager.hideAppsExcept(".apps .full",!0),d.views.introduction.doneIntroductionWithMessage(function(){i.remove()})}).fail(function(e){var t="An error occurred during registration. Please try again shortly.";e.responseJSON&&e.responseJSON.msg&&(t=e.responseJSON.msg);var n=new d.views.IntroductionTip({value:t});i.$el.find(".tip").html(n.render().$el.mFadeIn(500)),i.loading=!1})}}}),d.views.ResetPasswordPrompt=Backbone.View.extend({tagName:"span",template:d.templates["introduction-content-template"],events:{"keydown input":function(e){this.updateOnEnter(e),this.continueButton.showContinueButton(e)}},initialize:function(){d.views.introduction.addGlobalListeners(this,this.reset,this.handleBack);var e=this;this.continueButton=new d.views.ContinueButton({clicked:function(){return e.reset()}}),this.loading=!1},render:function(){var e=this,t={message:"What would you like your new password to be?"},n=new d.views.IntroductionButton({value:"Use a different email address",clicked:function(){return e.changeEmail()}});this.$el.html(this.template(t));var i=new d.views.ExpandableInput;this.$el.find(".question").after(i.render().$el),i.$el.attr({id:"introduction-input","data-test":"introduction-reset-password"}),this.$el.find(".buttons").append("Changing password for "+localStorage.email).append(n.render().$el),this.$el.find("input").attr("type","password").trigger("focus");var o=this;function a(){var e=o.$el.find(".question-title").outerWidth();o.$el.find(".input").css({"min-width":e}).trigger("focus")}return setTimeout(a,10),this.listenTo(l,"appsReady",a),this},handleBack:function(){l.sendEvent("Introduction","Password For Reset","Escape Pressed"),this.changeEmail()},changeEmail:function(){l.sendEvent("Introduction","Password For Reset","Change Email Clicked");var e=this;e.$el.mFadeOut(1e3,!0,function(){e.remove(),d.views.introduction.promptForEmail()})},updateOnEnter:function(e){l.utils.isTabOrEnter(e)&&this.reset()},reset:function(){l.sendEvent("Introduction","Password For Reset","Submit");var e=this,t=localStorage.email,n=this.$el.find("input")[0].value;if(n.length<6){var i=new d.views.IntroductionTip({value:"Passwords need to be at least 6 characters long."});e.$el.find(".tip").html(i.render().$el.mFadeIn(500))}else e.loading||(e.loading=!0,d.views.introduction.showLoading(),a.ajax({type:"POST",contentType:"application/json",data:JSON.stringify({name:l.models.customization.get("displayname"),email:t,password:n}),beforeSend:l.utils.setMomentumAuthHeader,url:l.globals.urlRootLogin+"user/forgot"}).done(function(){l.delayOnboardingForIntro=!0,l.widgetManager.hideAppsExcept(".apps .full",!0),d.views.introduction.doneIntroductionWithMessage(function(){l.commandManager.execute("notification.show","Confirm new password","A verification email will be sent to you shortly. To finish changing your password, click the link in the email.")})}).fail(function(){e.$el.find(".tip").html('<div class="loading">Sorry, we\'re having trouble connecting to our server. Please try again.</div>').mFadeIn(500),e.loading=!1}))}}),d.views.IntroductionTip=Backbone.View.extend({template:d.templates["introduction-tip-template"],render:function(){var e={value:this.options.value};return this.setElement(a(a.trim(this.template(e)))),this}}),d.views.IntroductionButton=Backbone.View.extend({template:d.templates["introduction-button-template"],events:{click:"clicked"},render:function(){var e={value:this.options.value,data:this.options.data};return this.setElement(a(a.trim(this.template(e)))),this},clicked:function(){this.options.clicked()}}),d.views.ContinueButton=Backbone.View.extend({template:d.templates["introduction-continue-button-template"],events:{click:"clicked"},render:function(){return this.setElement(a(a.trim(this.template()))),this},clicked:function(){this.options.clicked()},showContinueButton:_.debounce(function(e){this.continueButton||l.utils.isTabOrEnter(e)||(this.render(),a(".input").after(this.$el.mFadeIn()),this.continueButton=!0)},5e3)}),d.styles.style(),d.views.introduction=new d.views.Introduction({region:"full"}),d};m.addinManager&&m.addinManager.registerAddinFn("5965ea88-516a-41cb-a6dc-251a461d9075",fn_addin);